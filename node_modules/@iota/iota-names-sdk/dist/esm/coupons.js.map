{
  "version": 3,
  "sources": ["../../src/coupons.ts"],
  "sourcesContent": ["// Copyright (c) Mysten Labs, Inc.\n// Modifications Copyright (c) 2025 IOTA Stiftung\n// SPDX-License-Identifier: Apache-2.0\n\nimport { Coupon } from './types';\n\nexport const INVALID_YEARS = 'Coupon is not valid for the given number of years.';\nexport const INVALID_FOR_NAME_LENGTH = 'Coupon is not valid for the given name length.';\nexport const INVALID_PERCENTAGE = 'Invalid percentage amount for coupon.';\nexport const INVALID_USER = 'Coupon address does not match.';\nexport const COUPON_EXPIRED = 'Coupon has expired.';\nexport const INVALID_AVAILABLE_CLAIMS = 'Number of claims cannot be zero.';\nexport const NON_STACKING_COUPON = 'Coupon cannot be used with other coupons.';\n\nexport function validateCoupon(coupon: Coupon, years: number, length: number, address?: string) {\n    try {\n        hasAvailableClaims(coupon.rules);\n        isCouponValidForNameYears(coupon.rules, years);\n        // Percentage off coupon\n        if (coupon.kind === 0) {\n            isValidCouponPercentage(coupon.amount);\n        }\n        isCouponValidForNameLength(coupon.rules, length);\n        isCouponValidForAddress(coupon.rules, address);\n        isCouponExpired(coupon.rules);\n    } catch (error: unknown) {\n        throw new Error(\n            `Coupon '${coupon.couponCode}' validation failed: ${(error as Error)?.message}`,\n        );\n    }\n}\n\nexport function validateCoupons(\n    coupons: Coupon[],\n    years: number,\n    length: number,\n    address?: string,\n) {\n    for (const coupon of coupons) {\n        if (!coupon.rules.can_stack && coupons.length > 1) {\n            throw new Error(\n                `Coupon '${coupon.couponCode}' validation failed: ${NON_STACKING_COUPON}`,\n            );\n        }\n        validateCoupon(coupon, years, length, address);\n    }\n}\n\nexport function applyCouponsToPrice(coupons: Coupon[], initialPrice: number): number {\n    if (!coupons || coupons.length === 0) {\n        return initialPrice;\n    }\n\n    let price = initialPrice;\n\n    for (const coupon of coupons) {\n        if (!coupon.rules.can_stack && coupons.length > 1) {\n            throw new Error('Coupons provided cannot be stacked');\n        }\n\n        price = applyCouponToPrice(price, coupon);\n    }\n\n    return price;\n}\n\nexport function applyCouponToPrice(price: number, coupon?: Coupon): number {\n    if (!coupon) {\n        return price;\n    }\n\n    const couponAmount = Number(coupon.amount);\n\n    // 0 => percentage off\n    // 1 => fixed amount off,\n    if (coupon.kind === 0) {\n        let discountAmount = (price * couponAmount) / 100;\n        return price - discountAmount;\n    } else if (coupon.kind === 1) {\n        const discountedAmount = price - couponAmount;\n\n        return discountedAmount < 0 ? 0 : discountedAmount;\n    } else {\n        throw new Error(`Unknown coupon kind: ${coupon.kind}`);\n    }\n}\n\nexport function hasAvailableClaims(rules: { available_claims?: string | null }) {\n    if (\n        rules?.available_claims !== null &&\n        rules?.available_claims !== undefined &&\n        parseInt(rules?.available_claims) <= 0\n    ) {\n        throw new Error(INVALID_AVAILABLE_CLAIMS);\n    }\n}\n\nexport function isCouponValidForNameYears(\n    rules: { years?: { from: number; to: number } | null },\n    years: number,\n) {\n    const { from: minYears, to: maxYears } = rules.years || {};\n    if (minYears && maxYears && (years < minYears || years > maxYears)) {\n        throw new Error(INVALID_YEARS);\n    }\n}\n\nexport function isValidCouponPercentage(amount: string) {\n    if (parseInt(amount) <= 0 || parseInt(amount) > 100) {\n        throw new Error(INVALID_PERCENTAGE);\n    }\n}\n\nexport function isCouponValidForNameLength(\n    rules: { length?: { from: number; to: number } | null },\n    length: number,\n) {\n    const { from: minLength, to: maxLength } = rules.length || {};\n    if (minLength && maxLength && (length < minLength || length > maxLength)) {\n        throw new Error(INVALID_FOR_NAME_LENGTH);\n    }\n}\n\nexport function isCouponValidForAddress(rules: { user?: string | null }, userAddress?: string) {\n    if (rules.user && rules.user !== userAddress) {\n        throw new Error(INVALID_USER);\n    }\n}\n\nexport function isCouponExpired(\n    rules: { expiration?: string | null },\n    currentTimestamp: string = Date.now().toString(),\n) {\n    if (rules.expiration && Number(currentTimestamp) > Number(rules.expiration)) {\n        throw new Error(COUPON_EXPIRED);\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
