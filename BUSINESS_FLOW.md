# 停車場 RWA 系統 - 業務流程說明

## 🎯 業務模型

這是一個將實體停車格資產化（RWA）的系統，讓用戶可以購買停車格 NFT 並獲得停車費收益分潤。

## 👥 角色定義

### 1. Operator（營運商）
- **職責**: 擁有停車場，鑄造並出售停車格 NFT
- **收益**:
  - 出售停車格 NFT 的收入（一次性）
  - 每筆停車費的 80% 分潤（持續收益）

### 2. 車位持有者（Alice）
- **職責**: 購買停車格 NFT 成為資產持有者
- **收益**: 每筆停車費的 20% 分潤（被動收益）
- **權利**: 可以轉售或贈與停車格 NFT

### 3. 駕駛人（Bob）
- **職責**: 使用停車格並支付停車費
- **費用**: 根據停車時數支付費用

---

## 📊 完整業務流程

```
┌─────────────────────────────────────────────────────────────┐
│                      停車場 RWA 系統流程                      │
└─────────────────────────────────────────────────────────────┘

第一階段：初始化與銷售
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ┌──────────┐
  │ Operator │  1️⃣ 創建停車場
  └─────┬────┘       create_lot()
        │            ↓
        │       ┌─────────────┐
        │       │ ParkingLot  │
        │       │ - operator  │
        │       │ - rate: 80% │
        │       └─────────────┘
        │
        │  2️⃣ 鑄造停車格 NFT
        │       mint_space(lot, "A1", 1 IOTA/hr, 10 IOTA)
        │       ↓
        │  ┌──────────────────┐
        └──│ ParkingSpace A1  │
           │ - location: A1   │
           │ - rate: 1 IOTA/hr│
           │ - owner: Operator│
           │ - price: 10 IOTA │
           └────────┬─────────┘
                    │
                    │  3️⃣ Alice 購買停車格
                    │     purchase_space(space_A1)
                    │     支付：10 IOTA
                    ↓
  ┌─────────┐  ←10 IOTA─  ┌───────┐
  │Operator │              │ Alice │
  └─────────┘              └───┬───┘
                               │
                        ┌──────────────────┐
                        │ ParkingSpace A1  │
                        │ - owner: Alice   │ ← 所有權轉移
                        │ - price: 0       │ ← 不再出售
                        └──────────────────┘

第二階段：營運與收益
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ┌─────┐
  │ Bob │  4️⃣ 支付停車費（2 小時）
  └──┬──┘       pay_for_parking(lot, space_A1, 2)
     │          支付：2 IOTA
     │
     └─→  2 IOTA
             │
             ├─→ 1.6 IOTA (80%) ─→  ┌──────────┐
             │                       │ Operator │
             │                       └──────────┘
             │
             └─→ 0.4 IOTA (20%) ─→  ┌───────┐
                                     │ Alice │
                                     └───────┘

第三階段：二級市場交易（可選）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ┌───────┐
  │ Alice │  5️⃣ 出售停車格
  └───┬───┘       set_price(space_A1, 15 IOTA)
      │           ↓
      │      ┌──────────────────┐
      │      │ ParkingSpace A1  │
      │      │ - owner: Alice   │
      │      │ - price: 15 IOTA │ ← 設定售價
      │      └────────┬─────────┘
      │               │
      │               │  6️⃣ Charlie 購買
      │               │     purchase_space(space_A1)
      │               │     支付：15 IOTA
      │               ↓
  ┌───────┐  ←15 IOTA─  ┌─────────┐
  │ Alice │              │ Charlie │
  └───────┘              └────┬────┘
                              │
                       ┌──────────────────┐
                       │ ParkingSpace A1  │
                       │ - owner: Charlie │ ← 新所有者
                       │ - price: 0       │
                       └──────────────────┘

                       Charlie 現在獲得 20% 停車費分潤
```

---

## 💰 收益分析

### 場景：停車格 A1

**初始設定**:
- 鑄造成本: 忽略不計
- 售價: 10 IOTA
- 每小時停車費: 1 IOTA
- 分潤比例: Operator 80% / 持有者 20%

### Operator 收益

| 階段 | 收入來源 | 金額 | 累計收益 |
|------|---------|------|---------|
| 銷售階段 | Alice 購買停車格 | +10 IOTA | 10 IOTA |
| 第 1 次停車 | Bob 停 2 小時（80%） | +1.6 IOTA | 11.6 IOTA |
| 第 2 次停車 | 其他人停 3 小時（80%） | +2.4 IOTA | 14 IOTA |
| ... | 持續獲得 80% 分潤 | ... | ... |

### Alice 收益（車位持有者）

| 階段 | 收入/支出 | 金額 | 累計收益 |
|------|----------|------|---------|
| 購買階段 | 購買停車格 | -10 IOTA | -10 IOTA |
| 第 1 次停車 | Bob 停 2 小時（20%） | +0.4 IOTA | -9.6 IOTA |
| 第 2 次停車 | 其他人停 3 小時（20%） | +0.6 IOTA | -9 IOTA |
| 第 10 次停車 | 累計約停 25 小時 | +5 IOTA | **回本** |
| 持續營運 | 持續獲得 20% 分潤 | ... | 持續獲利 |

**回本週期**: 約需累計停車 50 小時（假設每小時 1 IOTA）

### Bob 支出（駕駛人）

| 停車時長 | 費用 |
|---------|------|
| 2 小時 | 2 IOTA |
| 3 小時 | 3 IOTA |
| 24 小時 | 24 IOTA |

---

## 🔄 NFT 流轉示例

### 情境：停車格 A1 的生命週期

```
時間軸：

T0: Operator 鑄造 A1
    └─ owner: Operator
       price: 10 IOTA

T1: Alice 購買 A1（支付 10 IOTA）
    └─ owner: Alice
       price: 0
    └─ Operator 收到: 10 IOTA

T2-T10: 累計停車收益
    └─ 總停車費: 50 IOTA
       ├─ Operator 獲得: 40 IOTA (80%)
       └─ Alice 獲得: 10 IOTA (20%)

T11: Alice 想退出，設定售價
    └─ set_price(15 IOTA)
       price: 15 IOTA

T12: Charlie 購買 A1（支付 15 IOTA）
    └─ owner: Charlie
       price: 0
    └─ Alice 收到: 15 IOTA
    └─ Alice 總收益: 10 + 15 - 10 = 15 IOTA

T13+: Charlie 開始獲得分潤
    └─ 每筆停車費的 20% 歸 Charlie
```

---

## 🎓 關鍵特性

### 1. 資產所有權明確
- 使用 Move 的物件模型，每個停車格都是獨立的 NFT
- 所有權鏈上可查，不可篡改

### 2. 收益自動分配
- 智能合約自動執行分潤
- 80/20 分潤比例寫死在合約中，無法作弊

### 3. 二級市場流通
- 持有者可以自由設定售價
- 支持 NFT 買賣轉讓
- 價格由市場決定

### 4. 權限控制嚴格
- 只有營運商可以鑄造停車格
- 只有持有者可以設定價格或轉讓
- 防止惡意攻擊

---

## 🚀 擴展場景

### 場景 1: 多車位持有者（投資組合）

Alice 可以購買多個停車格：
- A1, A2, B3 各 10 IOTA
- 總投資: 30 IOTA
- 分散風險，穩定收益

### 場景 2: 動態定價

Operator 可以根據地段調整費率：
- 市區停車格: 5 IOTA/小時
- 郊區停車格: 1 IOTA/小時
- 出售價格也相應調整

### 場景 3: 會員制度

停車格持有者享有特權：
- 免費停車
- 優先預約
- 社群投票權

---

## 📈 商業價值

### 對營運商
1. 快速回籠資金（出售 NFT）
2. 持續收益（80% 分潤）
3. 降低資金壓力

### 對投資者
1. 被動收益（20% 分潤）
2. 資產增值（NFT 價格上漲）
3. 流動性（二級市場交易）

### 對用戶
1. 透明公平的停車費
2. 鏈上可查的收費記錄
3. 參與停車場收益分配

---

## 🔐 安全保障

1. ✅ 營運商權限控制（mint_space）
2. ✅ 持有者權限驗證（set_price, transfer_space）
3. ✅ 支付金額驗證（pay_for_parking, purchase_space）
4. ✅ 所有權轉移原子性（不可能出現雙重支付）
5. ✅ 事件記錄完整（所有操作可追溯）

---

**系統狀態**: ✅ 已實現並通過編譯
**準備程度**: 🚀 可以部署到測試網進行測試
