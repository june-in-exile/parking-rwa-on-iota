# 停車場 RWA 系統 - User Stories

## Epic 1: 智能合約開發 (IOTA Move)

### Story 1.1: 建立核心資料結構 ✅
**As a** 系統開發者
**I want to** 定義 ParkingSpace 和 ParkingLot 物件結構
**So that** 可以在鏈上表示停車格資產和停車場營運實體

**Acceptance Criteria:**
- [x] 定義 ParkingSpace struct，包含 id, location, hourly_rate, owner 欄位
- [x] 定義 ParkingLot struct，包含 id, operator, commission_rate 欄位
- [x] 設置 commission_rate 預設值為 80% (使用 8000 基點)
- [x] 所有欄位型別符合 Move 語言規範

**實作位置:** [parking_rwa.move:10-22](move/sources/parking_rwa.move#L10-L22)

### Story 1.2: 實作車位鑄造功能 ✅
**As a** 停車場營運商
**I want to** 能夠鑄造新的停車格 NFT
**So that** 可以將實體車位資產化並開始營運

**Acceptance Criteria:**
- [x] 實作 mint_space 函數
- [x] 鑄造時自動設置 owner 為調用者地址
- [x] 將 ParkingSpace 物件轉移給鑄造者

**實作位置:** [parking_rwa.move:35-47](move/sources/parking_rwa.move#L35-L47)

**注意事項:**
- 目前實作允許任何人鑄造車位
- 如需限制只有營運商可鑄造，需添加權限檢查
- 未實作將車位加入 ParkingLot.spaces 追蹤（可作為未來優化）

### Story 1.3: 實作停車費支付與分潤 ✅
**As a** 駕駛人
**I want to** 支付停車費用
**So that** 可以使用停車格，並讓收益自動分配給車位持有者和營運商

**Acceptance Criteria:**
- [x] 實作 pay_for_parking 函數
- [x] 驗證支付金額 = hourly_rate × hours
- [x] 自動分配 20% 給 ParkingSpace.owner
- [x] 自動分配 80% 給 ParkingLot.operator
- [x] 支付失敗時正確回退交易 (透過 assert! 實現)
- [x] 發出 PaymentEvent 事件記錄交易 ✅

**實作位置:** [parking_rwa.move:68-102](move/sources/parking_rwa.move#L68-L102)

**✅ 最新更新 (2025-12-18):**
- 已添加 PaymentEvent 結構（包含 space_id, payer, hours, total_amount, owner_share, operator_share）
- pay_for_parking 函數現在會發出事件，前端可監聽

### Story 1.4: 實作車位轉讓功能 ✅
**As a** 車位持有者
**I want to** 在二級市場轉讓我的車位 NFT
**So that** 可以交易我的資產並轉移收益權

**Acceptance Criteria:**
- [x] 實作 transfer_space 函數
- [x] 添加權限檢查：只有當前 owner 可以轉讓 ✅
- [x] 更新 ParkingSpace.owner 為新持有者
- [x] 發出 TransferEvent 事件 ✅

**實作位置:** [parking_rwa.move:105-118](move/sources/parking_rwa.move#L105-L118)

**✅ 最新更新 (2025-12-18):**
- 已添加權限驗證：`assert!(space.owner == tx_context::sender(ctx), ENotOwner)`
- 已添加 TransferEvent 結構（包含 space_id, from, to）
- 函數簽名已更新，添加 `ctx: &mut TxContext` 參數
- 安全性問題已修復 🔒

---

## Epic 2: 前端應用開發

### Story 2.1: 錢包連接整合 🔄
**As a** 用戶
**I want to** 連接我的 IOTA 錢包
**So that** 可以與智能合約互動並進行交易

**Acceptance Criteria:**
- [x] 整合 @iota/dapp-kit (已在 PaymentCard 中使用)
- [ ] 實作錢包連接 UI 組件
- [ ] 支援 IOTA Wallet 連接
- [ ] 支援 Enoki 錢包連接
- [ ] 顯示當前連接的錢包地址
- [ ] 顯示錢包 IOTA 餘額

**實作位置:** [PaymentCard.tsx:1](frontend/src/components/PaymentCard.tsx#L1)

**待完成:**
- 需要實作完整的錢包連接 Provider
- 添加錢包狀態管理組件

### Story 2.2: 車位資產展示頁面
**As a** 用戶
**I want to** 查看所有可用的停車格
**So that** 可以選擇適合的車位進行停車

**Acceptance Criteria:**
- [ ] 從鏈上拉取所有 ParkingSpace 物件
- [ ] 顯示車位編號/地址
- [ ] 顯示每小時費率
- [ ] 顯示當前擁有者
- [ ] 支援篩選與搜尋功能

### Story 2.3: 停車費支付介面 ✅
**As a** 駕駛人
**I want to** 選擇車位並支付停車費
**So that** 可以完成停車並開始使用車位

**Acceptance Criteria:**
- [x] 實作 createParkingPaymentTx 交易建構函數
- [x] 自動計算總費用 (Rate × Hours)
- [x] 觸發錢包簽署交易
- [x] 使用 useSignAndExecuteTransactionBlock hook
- [x] 基礎交易成功/失敗回調
- [ ] 提供車位選擇 UI (待完成)
- [ ] 輸入停車時數 UI（目前硬編碼 1 小時）
- [ ] 完整的交易狀態顯示 UI
- [ ] 交易成功後顯示交易 hash UI

**實作位置:**
- [parking.ts](frontend/src/contracts/parking.ts) - 交易建構
- [PaymentCard.tsx](frontend/src/components/PaymentCard.tsx) - 支付組件
- [ids.ts](frontend/src/constants/ids.ts) - 合約常數

**待完成:**
- 完善 UI 組件（輸入框、選擇器等）
- 添加交易狀態顯示
- 改進錯誤處理與用戶反饋

### Story 2.4: 收益看板
**As a** 車位持有者
**I want to** 查看我擁有的車位及收益情況
**So that** 可以追蹤我的投資回報

**Acceptance Criteria:**
- [ ] 顯示持有者擁有的所有車位編號
- [ ] 顯示每個車位的總收益
- [ ] 顯示歷史分潤記錄
- [ ] 顯示收益統計圖表
- [ ] 支援匯出收益報表

### Story 2.5: 狀態管理與鏈上數據同步
**As a** 開發者
**I want to** 高效地同步鏈上數據
**So that** 前端可以即時顯示最新的車位狀態

**Acceptance Criteria:**
- [ ] 使用 React Query 或 useSWR 管理狀態
- [ ] 定期輪詢鏈上車位狀態
- [ ] 實作快取機制減少 RPC 調用
- [ ] 監聽鏈上事件自動更新 UI

---

## Epic 3: 離鏈處理與整合

### Story 3.1: 事件監聽與索引
**As a** 系統管理員
**I want to** 監聽並索引鏈上支付事件
**So that** 可以快速查詢歷史交易記錄

**Acceptance Criteria:**
- [ ] 使用 IOTA RPC 監聽 PaymentEvent
- [ ] 將事件數據存入資料庫
- [ ] 建立索引加速查詢
- [ ] 提供 API 供前端查詢歷史記錄

### Story 3.2: IoT 硬體整合
**As a** 停車場營運商
**I want to** 在支付成功後自動控制地鎖
**So that** 用戶完成支付後可立即使用車位

**Acceptance Criteria:**
- [ ] 後端接收到支付成功事件
- [ ] 發送控制指令到停車場硬體
- [ ] 自動升降地鎖
- [ ] 記錄硬體操作日誌

---

## Epic 4: 專案基礎設施

### Story 4.1: 專案架構初始化 ✅
**As a** 開發者
**I want to** 建立標準的專案結構
**So that** 團隊可以高效協作開發

**Acceptance Criteria:**
- [x] 建立 move/ 目錄與 Move.toml 配置
- [x] 建立 frontend/ 目錄（React）
- [x] 實作基礎目錄結構 (src/components, src/hooks, src/contracts, src/constants)
- [x] 建立 .env.example 環境變數範本
- [ ] 配置 TypeScript 與 ESLint (待確認)
- [ ] 建立 .gitignore (已建立)
- [ ] 建立 README.md (已建立)

**已建立的檔案結構:**
```
parking-rwa-on-iota/
├── move/
│   ├── Move.toml
│   └── sources/
│       └── parking_rwa.move
├── frontend/
│   └── src/
│       ├── components/
│       │   └── PaymentCard.tsx
│       ├── hooks/
│       │   └── useParking.ts
│       ├── contracts/
│       │   └── parking.ts
│       └── constants/
│           └── ids.ts
├── .env.example
├── .gitignore
└── README.md
```

### Story 4.2: 測試環境建置
**As a** 開發者
**I want to** 建立完整的測試環境
**So that** 可以確保代碼品質與功能正確性

**Acceptance Criteria:**
- [ ] 配置 Move 合約測試框架
- [ ] 撰寫合約單元測試
- [ ] 配置前端測試（Jest + React Testing Library）
- [ ] 建立 E2E 測試流程
- [ ] 設置 CI/CD pipeline

### Story 4.3: 部署與文檔
**As a** 專案負責人
**I want to** 完善部署流程與文檔
**So that** 團隊成員和用戶可以順利使用系統

**Acceptance Criteria:**
- [ ] 撰寫合約部署腳本
- [ ] 部署到 IOTA 測試網
- [ ] 撰寫 API 文檔
- [ ] 撰寫用戶使用指南
- [ ] 建立開發者文檔
- [ ] 準備 Demo 環境

---

## 優先級建議

**Phase 1 (MVP):**
- Story 4.1: 專案架構初始化
- Story 1.1: 建立核心資料結構
- Story 1.2: 實作車位鑄造功能
- Story 1.3: 實作停車費支付與分潤
- Story 2.1: 錢包連接整合
- Story 2.3: 停車費支付介面

**Phase 2 (完整功能):**
- Story 1.4: 實作車位轉讓功能
- Story 2.2: 車位資產展示頁面
- Story 2.4: 收益看板
- Story 2.5: 狀態管理與鏈上數據同步
- Story 4.2: 測試環境建置

**Phase 3 (優化與擴展):**
- Story 3.1: 事件監聽與索引
- Story 3.2: IoT 硬體整合
- Story 4.3: 部署與文檔

---

## 📊 目前進度總結

### ✅ 已完成 (7 個 Stories)
1. **Story 1.1** - 建立核心資料結構 ✅
2. **Story 1.2** - 實作車位鑄造功能 ✅
3. **Story 1.3** - 實作停車費支付與分潤 ✅（包含 Event）
4. **Story 1.4** - 實作車位轉讓功能 ✅（包含權限檢查與 Event）
5. **Story 2.3** - 停車費支付介面（核心邏輯完成，UI 待完善）
6. **Story 4.1** - 專案架構初始化 ✅
7. **合約編譯測試** - 編譯成功 ✅

### 🔄 進行中 (1 個 Stories)
1. **Story 2.1** - 錢包連接整合（已整合 hook，UI 待完成）

### ⏳ 待開始 (11 個 Stories)
- Story 2.2 - 車位資產展示頁面
- Story 2.4 - 收益看板
- Story 2.5 - 狀態管理與鏈上數據同步
- Story 3.1 - 事件監聽與索引
- Story 3.2 - IoT 硬體整合
- Story 4.2 - 測試環境建置
- Story 4.3 - 部署與文檔

### 🚨 需要優先處理的問題

#### ✅ 已修復的問題
1. **~~安全性問題~~** ✅
   - ~~`transfer_space` 缺少權限驗證（任何人都可更改 owner）~~
   - ✅ 已添加 `assert!(space.owner == tx_context::sender(ctx), ENotOwner)`

2. **~~功能完整性~~** ✅
   - ✅ 已添加 PaymentEvent 和 TransferEvent
   - ✅ 已添加 ENotOwner 錯誤代碼
   - `create_lot` 功能已存在於合約中

#### ⏳ 待處理的問題
3. **前端待完成:**
   - 完整的錢包連接 UI
   - 車位選擇與時數輸入介面
   - 交易狀態顯示
   - 更新 PACKAGE_ID 和 LOT_ID (目前為佔位符)
   - 更新 transfer_space 前端調用（需添加 ctx 參數）

4. **合約部署:**
   - 測試合約編譯
   - 部署到 IOTA 測試網
   - 更新前端常數（PACKAGE_ID, LOT_ID）

### 📝 下一步建議
**建議優先完成 Phase 1 MVP:**
1. ✅ ~~修復 Story 1.4 的權限問題~~
2. ✅ ~~添加 Event 到 Story 1.3 和 1.4~~
3. ⏳ 測試合約編譯並部署到 IOTA 測試網（進行中）
4. ⏳ 完善 Story 2.3 的 UI 組件
5. ⏳ 完成 Story 2.1 的錢包連接 UI
6. ⏳ 實作 Story 2.2 車位展示頁面
7. ⏳ 更新 ids.ts 中的實際合約地址
